<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Project Playcare</title>
<style>
body{margin:0;overflow:hidden;background:black;font-family:Arial}
#uiHealth{
position:absolute;top:20px;left:20px;width:200px;height:20px;
background:#222;border:2px solid white;display:none
}
#healthBar{height:100%;width:100%;background:red}
#title,#loading,#ending{
position:absolute;width:100%;height:100%;
display:flex;flex-direction:column;
align-items:center;justify-content:center;
background:black;color:white;z-index:20
}
#title h1{font-size:48px;margin:0}
button{padding:10px 20px;margin-top:20px;font-size:18px;cursor:pointer}
#crosshair{
position:absolute;top:50%;left:50%;
width:6px;height:6px;background:white;
transform:translate(-50%,-50%);
display:none
}
</style>
</head>
<body>

<div id="title">
<h1>PROJECT PLAYCARE</h1>
<button id="startBtn">Start</button>
</div>

<div id="loading" style="display:none;">Loading...</div>
<div id="ending" style="display:none;"><h1>GAME COMPLETE</h1></div>

<div id="uiHealth"><div id="healthBar"></div></div>
<div id="crosshair"></div>

<audio id="titleMusic" src="Title music.mp3" loop></audio>
<audio id="hallMusic" src="Bgm-1.mp3" loop></audio>
<audio id="bossMusic" src="chase music.mp3" loop></audio>
<audio id="protoMusic" src="Prototype encounter music.mp3" loop></audio>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>

let state="title"
const title=document.getElementById("title")
const loading=document.getElementById("loading")
const ending=document.getElementById("ending")
const crosshair=document.getElementById("crosshair")
const healthUI=document.getElementById("uiHealth")
const healthBar=document.getElementById("healthBar")

const titleMusic=document.getElementById("titleMusic")
const hallMusic=document.getElementById("hallMusic")
const bossMusic=document.getElementById("bossMusic")
const protoMusic=document.getElementById("protoMusic")

function fadeIn(a,v=1,d=2000){
a.volume=0;a.play()
let step=v/(d/50)
let i=setInterval(()=>{
a.volume=Math.min(v,a.volume+step)
if(a.volume>=v)clearInterval(i)
},50)
}
function fadeOut(a,d=2000){
let step=a.volume/(d/50)
let i=setInterval(()=>{
a.volume=Math.max(0,a.volume-step)
if(a.volume<=0){a.pause();clearInterval(i)}
},50)
}

fadeIn(titleMusic)

document.getElementById("startBtn").onclick=()=>{
fadeOut(titleMusic)
title.style.display="none"
loading.style.display="flex"
setTimeout(()=>{
loading.style.display="none"
initGame()
fadeIn(hallMusic,.6)
state="hall"
},1500)
}

/* THREE CORE */
let scene,camera,renderer,player,catnap,generator,gas
let colliders=[]
let yaw=0,pitch=0
let keys={}
let velocityY=0
let health=100
let batteries=0
let doorToBoss
let bossDoor
let gasHeight=0

function addCollider(m){
m.userData.box=new THREE.Box3().setFromObject(m)
colliders.push(m)
}
function checkCollision(pos){
const box=new THREE.Box3().setFromCenterAndSize(pos,new THREE.Vector3(1.2,3,1.2))
for(let o of colliders){
o.userData.box.setFromObject(o)
if(box.intersectsBox(o.userData.box))return true
}
return false
}
function wall(x,y,z,w,h,d,mat){
const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),mat)
m.position.set(x,y,z)
scene.add(m)
addCollider(m)
}

function initGame(){

scene=new THREE.Scene()
scene.fog=new THREE.Fog(0x220000,20,200)
camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,2000)
renderer=new THREE.WebGLRenderer({antialias:true})
renderer.setSize(innerWidth,innerHeight)
document.body.appendChild(renderer.domElement)
renderer.domElement.addEventListener("click",()=>renderer.domElement.requestPointerLock())

scene.add(new THREE.AmbientLight(0xffffff,.4))
const light=new THREE.PointLight(0xff0000,1,50)
light.position.set(0,8,0)
scene.add(light)

const metal=new THREE.MeshStandardMaterial({color:0x555555})
const dark=new THREE.MeshStandardMaterial({color:0x222222})
const red=new THREE.MeshStandardMaterial({color:0xaa0000})
const yellow=new THREE.MeshStandardMaterial({color:0xffcc00})

/* FLOOR */
const floor=new THREE.Mesh(new THREE.PlaneGeometry(20,200),metal)
floor.rotation.x=-Math.PI/2
floor.position.z=-50
scene.add(floor)

/* HALLWAY WALLS */
wall(-5,5,-50,1,10,200,metal)
wall(5,5,-50,1,10,200,metal)
wall(0,9,-50,10,1,200,dark)

/* GAS */
gas=new THREE.Mesh(new THREE.BoxGeometry(10,1,200),
new THREE.MeshStandardMaterial({color:0xff0000,transparent:true,opacity:.4}))
gas.position.set(0,0,-50)
scene.add(gas)

/* DOOR TO BOSS */
doorToBoss=new THREE.Mesh(new THREE.BoxGeometry(8,8,1),dark)
doorToBoss.position.set(0,4,-150)
scene.add(doorToBoss)
addCollider(doorToBoss)

/* PLAYER */
player=new THREE.Object3D()
player.position.set(0,2,20)
scene.add(player)
player.add(camera)
crosshair.style.display="block"
healthUI.style.display="block"

/* CONTROLS */
document.addEventListener("mousemove",e=>{
if(document.pointerLockElement===renderer.domElement){
yaw-=e.movementX*.002
pitch-=e.movementY*.002
pitch=Math.max(-Math.PI/2,Math.min(Math.PI/2,pitch))
player.rotation.y=yaw
camera.rotation.x=pitch
}})
document.addEventListener("keydown",e=>keys[e.code]=true)
document.addEventListener("keyup",e=>keys[e.code]=false)

animate()
}

function buildBossArena(){
fadeOut(hallMusic)
fadeIn(bossMusic,.7)
state="boss"

/* Arena */
const mat=new THREE.MeshStandardMaterial({color:0x444444})
const arenaFloor=new THREE.Mesh(new THREE.CircleGeometry(30,32),mat)
arenaFloor.rotation.x=-Math.PI/2
arenaFloor.position.z=-200
scene.add(arenaFloor)

generator=new THREE.Mesh(new THREE.CylinderGeometry(4,4,8,16),
new THREE.MeshStandardMaterial({color:0x00ffff}))
generator.position.set(0,4,-200)
scene.add(generator)
addCollider(generator)

/* Batteries */
for(let i=0;i<4;i++){
let b=new THREE.Mesh(new THREE.BoxGeometry(2,2,2),
new THREE.MeshStandardMaterial({color:0xffff00}))
b.position.set((Math.random()-0.5)*40,1,-200+(Math.random()-0.5)*40)
scene.add(b)
b.userData.battery=true
}

/* CatNap */
catnap=new THREE.Mesh(new THREE.BoxGeometry(4,6,4),
new THREE.MeshStandardMaterial({color:0x5500aa}))
catnap.position.set(10,3,-200)
scene.add(catnap)
}

function endGame(){
fadeOut(bossMusic)
fadeIn(protoMusic,.6)
state="ending"
setTimeout(()=>{
ending.style.display="flex"
},4000)
}

function animate(){
requestAnimationFrame(animate)
if(!scene)return
let delta=.016

/* MOVEMENT */
let forward=new THREE.Vector3()
camera.getWorldDirection(forward);forward.y=0;forward.normalize()
let right=new THREE.Vector3()
right.crossVectors(forward,new THREE.Vector3(0,1,0)).normalize()
let dir=new THREE.Vector3()
if(keys["KeyW"])dir.add(forward)
if(keys["KeyS"])dir.sub(forward)
if(keys["KeyA"])dir.sub(right)
if(keys["KeyD"])dir.add(right)
dir.normalize()
let newPos=player.position.clone().addScaledVector(dir,8*delta)
if(!checkCollision(newPos)){player.position.x=newPos.x;player.position.z=newPos.z}

/* GRAVITY */
velocityY-=30*delta
if(keys["Space"]&&player.position.y<=2){velocityY=12}
player.position.y+=velocityY*delta
if(player.position.y<2){player.position.y=2;velocityY=0}

/* HALL STATE */
if(state==="hall"){
gasHeight+=.01
gas.scale.y=gasHeight
gas.position.y=gasHeight/2
if(player.position.y<gasHeight){
health-=.2
healthBar.style.width=health+"%"
}
if(player.position.z<-145){
buildBossArena()
}
}

/* BOSS STATE */
if(state==="boss"){
if(catnap){
let dir=new THREE.Vector3().subVectors(player.position,catnap.position).normalize()
catnap.position.addScaledVector(dir,3*delta)
if(catnap.position.distanceTo(player.position)<3){
health-=.5
healthBar.style.width=health+"%"
}
}
/* pickup */
scene.children.forEach(o=>{
if(o.userData.battery && o.position.distanceTo(player.position)<3){
scene.remove(o)
batteries++
}
})
/* insert */
if(batteries>0 && player.position.distanceTo(generator.position)<6){
if(keys["KeyE"]){
batteries--
generator.material.color.set(0x00ff00)
}
}
if(batteries===0 && generator.material.color.getHex()===0x00ff00){
catnap.visible=false
bossMusic.pause()
fadeIn(protoMusic,.6)
setTimeout(endGame,3000)
}
}

if(health<=0){location.reload()}

renderer.render(scene,camera)
}

window.addEventListener("resize",()=>{
if(camera){
camera.aspect=innerWidth/innerHeight
camera.updateProjectionMatrix()
renderer.setSize(innerWidth,innerHeight)
}
})

</script>
</body>
</html>
