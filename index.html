<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PROJECT: PLAYCARE – Chapter 1</title>
<style>
body{
  margin:0;
  overflow:hidden;
  background:#02030a;
  font-family:Arial, system-ui, sans-serif;
  color:white;
}

/* TITLE SCREEN */
#titleScreen{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:linear-gradient(160deg, #050814 0%, #02030a 40%, #050814 100%);
  z-index:30;
}
#titleBackdrop{
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at 20% 20%, rgba(255,0,0,0.08) 0, transparent 45%),
    radial-gradient(circle at 80% 70%, rgba(0,120,255,0.12) 0, transparent 50%);
  pointer-events:none;
  opacity:0.9;
}
#titleContent{
  position:relative;
  text-align:center;
}
#titleLogo{
  margin:0;
  text-transform:uppercase;
  letter-spacing:8px;
}
#titleLogo span:nth-child(1){
  display:block;
  font-size:18px;
  color:#ff4a4a;
}
#titleLogo span:nth-child(2){
  display:block;
  font-size:40px;
}
#titleTagline{
  margin-top:6px;
  font-size:13px;
  opacity:.78;
  animation:tagPulse 2.8s ease-in-out infinite;
}
@keyframes tagPulse{
  0%,100%{opacity:.45;}
  50%{opacity:1;}
}
#titleButtons{
  margin-top:26px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.titleBtn{
  padding:10px 32px;
  font-size:15px;
  letter-spacing:2px;
  text-transform:uppercase;
  border:none;
  border-radius:4px;
  cursor:pointer;
  background:#ff2222;
  color:white;
  box-shadow:0 0 14px rgba(0,0,0,0.5);
  transition:background .15s,transform .1s,box-shadow .15s;
}
.titleBtn:hover{
  background:#ff4444;
  transform:translateY(-1px);
  box-shadow:0 0 22px rgba(255,60,60,0.6);
}

/* SETTINGS */
#settingsPanel{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  width:320px;
  padding:16px 18px;
  background:rgba(3,4,10,0.95);
  border:1px solid #444;
  box-shadow:0 0 22px rgba(0,0,0,0.9);
  display:none;
  z-index:35;
}
#settingsPanel h2{
  margin:0 0 10px 0;
  font-size:18px;
  letter-spacing:2px;
}
.settingRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:8px 0;
  font-size:13px;
}
.settingRow input[type=range]{width:170px;}
.settingRow input[type=checkbox]{transform:scale(1.1);}
#settingsClose{
  margin-top:12px;
  padding:6px 14px;
  font-size:13px;
  border:none;
  border-radius:4px;
  background:#444;
  color:white;
  cursor:pointer;
}
#settingsClose:hover{background:#666;}

/* HUD */
#hud,#info{
  position:absolute;
  left:20px;
  bottom:20px;
  color:white;
  font-size:14px;
  text-shadow:0 0 4px #000;
  z-index:10;
  white-space:pre-line;
  display:none;
}
#info{
  left:auto;
  right:20px;
  bottom:auto;
  top:20px;
  font-size:13px;
  text-align:right;
}
#crosshair{
  position:absolute;
  top:50%;left:50%;
  width:6px;height:6px;
  background:white;
  transform:translate(-50%,-50%);
  display:none;
  z-index:10;
}

/* GAME OVER / CREDITS / JUMPSCARE */
#gameOver,#credits,#jumpscare{
  position:absolute;
  inset:0;
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:black;
  color:white;
  z-index:40;
}
#gameOver h1,#credits h1{
  margin-bottom:10px;
  letter-spacing:4px;
}
#jumpscare img{
  max-width:100%;
  max-height:100%;
  object-fit:contain;
}

/* Canvas */
#gameCanvas{
  position:fixed;
  inset:0;
  display:block;
  z-index:0;
}
</style>
</head>
<body>

<!-- TITLE SCREEN -->
<div id="titleScreen">
  <div id="titleBackdrop"></div>
  <div id="titleContent">
    <h1 id="titleLogo">
      <span>PROJECT:</span>
      <span>PLAYCARE</span>
    </h1>
    <div id="titleTagline">“Everyone disappeared. They’re still here.”</div>
    <div id="titleButtons">
      <button class="titleBtn" id="playBtn">Play</button>
      <button class="titleBtn" id="settingsBtn">Settings</button>
      <button class="titleBtn" id="quitBtn">Quit</button>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div id="settingsPanel">
  <h2>SETTINGS</h2>
  <div class="settingRow">
    <span>Master Volume</span>
    <input id="volumeSlider" type="range" min="0" max="100" value="75">
  </div>
  <div class="settingRow">
    <span>Mouse Sensitivity</span>
    <input id="sensSlider" type="range" min="20" max="200" value="80">
  </div>
  <div class="settingRow">
    <span>Flashlight Enabled</span>
    <input id="flashToggle" type="checkbox" checked>
  </div>
  <button id="settingsClose">Back</button>
</div>

<!-- HUD -->
<div id="hud"></div>
<div id="info"></div>
<div id="crosshair"></div>

<!-- GAME OVER / CREDITS / JUMPSCARE -->
<div id="gameOver">
  <h1>YOU DIED</h1>
  <p>Huggy found you in the vents.\n\nPress REFRESH to try again from the factory entrance.</p>
</div>
<div id="credits">
  <h1>CHAPTER 1 COMPLETE</h1>
  <p>You opened Poppy’s case.\nShe’s finally awake.\n\nThanks for playing this web fan demo.</p>
</div>
<div id="jumpscare">
  <!-- <img src="huggy_jumpscare.png" alt="Huggy"> -->
</div>

<!-- AUDIO -->
<audio id="titleMusic" src="Title music.mp3" loop></audio>
<audio id="hallMusic" src="Bgm-1.mp3" loop></audio>
<audio id="chaseMusic" src="chase music.mp3" loop></audio>
<audio id="protoMusic" src="Prototype encounter music.mp3" loop></audio>
<audio id="jumpscareSound" src="jumpscare.mp3"></audio>

<canvas id="gameCanvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
// ===== TITLE + SETTINGS =====
const titleScreen=document.getElementById("titleScreen");
const playBtn=document.getElementById("playBtn");
const settingsBtn=document.getElementById("settingsBtn");
const quitBtn=document.getElementById("quitBtn");
const settingsPanel=document.getElementById("settingsPanel");
const settingsClose=document.getElementById("settingsClose");
const volumeSlider=document.getElementById("volumeSlider");
const sensSlider=document.getElementById("sensSlider");
const flashToggle=document.getElementById("flashToggle");

const titleMusic=document.getElementById("titleMusic");
const hallMusic=document.getElementById("hallMusic");
const chaseMusic=document.getElementById("chaseMusic");
const protoMusic=document.getElementById("protoMusic");
const jumpscareSound=document.getElementById("jumpscareSound");

const hud=document.getElementById("hud");
const info=document.getElementById("info");
const crosshair=document.getElementById("crosshair");
const gameOverUI=document.getElementById("gameOver");
const creditsUI=document.getElementById("credits");
const jumpscare=document.getElementById("jumpscare");

const options={
  masterVolume:0.75,
  mouseSensitivity:0.08,
  flashlightEnabled:true
};

function fadeIn(audio,target=0.75,duration=1500){
  audio.volume=0;
  audio.play().catch(()=>{});
  const step=target/(duration/50);
  const id=setInterval(()=>{
    audio.volume=Math.min(target,audio.volume+step);
    if(audio.volume>=target)clearInterval(id);
  },50);
}
function fadeOut(audio,duration=1500){
  const step=(audio.volume||0)/(duration/50||1);
  const id=setInterval(()=>{
    audio.volume=Math.max(0,audio.volume-step);
    if(audio.volume<=0){audio.pause();clearInterval(id);}
  },50);
}
function stopAllMusic(){
  [titleMusic,hallMusic,chaseMusic,protoMusic].forEach(a=>{a.pause();a.currentTime=0;});
}
function applyMasterVolume(){
  [titleMusic,hallMusic,chaseMusic,protoMusic].forEach(a=>{a.volume=options.masterVolume;});
}

// initial title music
applyMasterVolume();
fadeIn(titleMusic,options.masterVolume);

volumeSlider.addEventListener("input",()=>{
  options.masterVolume=Number(volumeSlider.value)/100;
  applyMasterVolume();
});
sensSlider.addEventListener("input",()=>{
  options.mouseSensitivity=Number(sensSlider.value)/1000;
});
flashToggle.addEventListener("change",()=>{
  options.flashlightEnabled=flashToggle.checked;
  if(window.gameFlashlight)gameFlashlight.visible=options.flashlightEnabled;
});

settingsBtn.onclick=()=>settingsPanel.style.display="block";
settingsClose.onclick=()=>settingsPanel.style.display="none";
quitBtn.onclick=()=>{
  titleScreen.style.display="none";
  fadeOut(titleMusic,800);
};

playBtn.onclick=()=>{
  titleScreen.style.display="none";
  settingsPanel.style.display="none";
  fadeOut(titleMusic,800);
  startGame();
};

// ===== GAME STATE =====
let scene,camera,renderer,player,gameFlashlight;
let yaw=0,pitch=0;
const keys={};
const collisionBoxes=[];
let state="lobby"; // lobby, security, power, fuses, makeFriend, chase, catwalks, poppy, dead, credits

// objects by state
let huggyStatue=null;
let greenTape=null;
let securityDoor=null;
let grabpack=null;
let powerPad=null;
let factoryDoor=null;
let fuseMeshes=[];
let fusePanel=null;
let toyNodes=[];
let toyGate=null;
let catBee=null;
let huggyChase=null;
let crate=null;
let poppyDoor=null;
let poppyCase=null;

// inventory
const inventory={
  haveTape:false,
  grabHands:0,
  fuses:0,
  toyCrafted:false
};

function triggerJumpscareAndDeath(){
  if(state==="dead"||state==="credits")return;
  state="dead";
  stopAllMusic();
  jumpscare.style.display="flex";
  if(jumpscareSound){
    jumpscareSound.currentTime=0;
    jumpscareSound.play().catch(()=>{});
  }
  setTimeout(()=>{
    jumpscare.style.display="none";
    gameOverUI.style.display="flex";
    crosshair.style.display="none";
    hud.textContent="";
    info.textContent="";
  },600);
}

// ===== THREE INITIALISE =====
function startGame(){
  const canvas=document.getElementById("gameCanvas");
  renderer=new THREE.WebGLRenderer({canvas,antialias:true});
  renderer.setSize(window.innerWidth,window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio||1);
  renderer.shadowMap.enabled=true;

  scene=new THREE.Scene();
  scene.background=new THREE.Color(0x060814);
  scene.fog=new THREE.Fog(0x070a16,40,200); // normal, slightly moody [web:43]

  camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,2000);

  player=new THREE.Object3D();
  player.position.set(0,2,18);
  scene.add(player);
  player.add(camera);

  const ambient=new THREE.AmbientLight(0x8888aa,0.7);
  scene.add(ambient);
  const lobbyLight=new THREE.PointLight(0xffffff,1.2,60);
  lobbyLight.position.set(0,7,0);
  lobbyLight.castShadow=true;
  scene.add(lobbyLight);

  gameFlashlight=new THREE.SpotLight(0xffffff,2.0,45,Math.PI/8,0.5);
  gameFlashlight.castShadow=true;
  camera.add(gameFlashlight);
  scene.add(camera);
  gameFlashlight.visible=options.flashlightEnabled;

  buildFactory();

  hud.style.display="block";
  info.style.display="block";
  crosshair.style.display="block";
  hud.textContent="LOBBY\nFind the green tape.";
  info.textContent="Hands: 0 | Fuses: 0 | Toy: no";

  renderer.domElement.requestPointerLock=
    renderer.domElement.requestPointerLock||
    renderer.domElement.mozRequestPointerLock;
  renderer.domElement.addEventListener("click",()=>renderer.domElement.requestPointerLock());

  document.addEventListener("mousemove",onMouseMove);
  document.addEventListener("keydown",onKeyDown);
  document.addEventListener("keyup",e=>{keys[e.code]=false;});

  window.addEventListener("resize",()=>{
    camera.aspect=window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
  });

  stopAllMusic();
  applyMasterVolume();
  fadeIn(hallMusic,options.masterVolume);

  animate();
}

function onMouseMove(e){
  if(document.pointerLockElement!==renderer?.domElement)return;
  yaw-=e.movementX*options.mouseSensitivity;
  pitch-=e.movementY*options.mouseSensitivity;
  pitch=Math.max(-Math.PI/2,Math.min(Math.PI/2,pitch));
  player.rotation.y=yaw;
  camera.rotation.x=pitch;
}

function onKeyDown(e){
  keys[e.code]=true;
  if(e.code==="KeyF"){
    options.flashlightEnabled=!options.flashlightEnabled;
    gameFlashlight.visible=options.flashlightEnabled;
    flashToggle.checked=options.flashlightEnabled;
  }
  if(e.code==="KeyE"){
    tryInteract();
  }
}

// ===== GEOMETRY + COLLISION =====
const wallMat=new THREE.MeshStandardMaterial({color:0x262c3e,roughness:0.7});
const floorMat=new THREE.MeshStandardMaterial({color:0x1b1f2d,roughness:0.85});
const trimMat=new THREE.MeshStandardMaterial({color:0x424a66,roughness:0.6});
const hudMat=new THREE.MeshStandardMaterial({color:0x004477});

function addCollisionFrom(mesh){
  const box=new THREE.Box3().setFromObject(mesh);
  collisionBoxes.push(box);
}

function makeRoom(width,depth,height=8){
  const g=new THREE.Group();
  const floor=new THREE.Mesh(new THREE.BoxGeometry(width,0.3,depth),floorMat);
  floor.position.set(0,0,0);
  floor.receiveShadow=true;
  g.add(floor);
  addCollisionFrom(floor);

  const wallF=new THREE.Mesh(new THREE.BoxGeometry(width,height,0.4),wallMat);
  wallF.position.set(0,height/2,-depth/2);
  g.add(wallF); addCollisionFrom(wallF);
  const wallB=wallF.clone();
  wallB.position.z=depth/2;
  g.add(wallB); addCollisionFrom(wallB);

  const wallL=new THREE.Mesh(new THREE.BoxGeometry(0.4,height,depth),wallMat);
  wallL.position.set(-width/2,height/2,0);
  g.add(wallL); addCollisionFrom(wallL);
  const wallR=wallL.clone();
  wallR.position.x=width/2;
  g.add(wallR); addCollisionFrom(wallR);

  const trim=new THREE.Mesh(new THREE.BoxGeometry(width+0.5,0.3,depth+0.5),trimMat);
  trim.position.set(0,height,0);
  g.add(trim);
  return g;
}

function buildFactory(){
  // Lobby
  const lobby=makeRoom(30,30,8);
  lobby.position.set(0,0,0);
  scene.add(lobby);

  huggyStatue=new THREE.Mesh(new THREE.CylinderGeometry(1.2,1.2,5,8),hudMat);
  huggyStatue.position.set(0,2.8,-4);
  huggyStatue.castShadow=true;
  lobby.add(huggyStatue);
  const hHead=new THREE.Mesh(new THREE.SphereGeometry(1.4,16,16),hudMat);
  hHead.position.set(0,5.6,-4);
  huggyStatue.add(hHead);

  const desk=new THREE.Mesh(new THREE.BoxGeometry(8,1.5,2),trimMat);
  desk.position.set(0,1,6);
  desk.castShadow=true;
  lobby.add(desk);
  addCollisionFrom(desk);

  greenTape=new THREE.Mesh(new THREE.BoxGeometry(0.5,0.3,0.2),new THREE.MeshStandardMaterial({color:0x00ff00}));
  greenTape.position.set(-5,1.2,2);
  greenTape.userData.type="tape";
  lobby.add(greenTape);

  // Security Office to right
  const secRoom=makeRoom(10,10,6);
  secRoom.position.set(15,0,5);
  scene.add(secRoom);

  securityDoor=new THREE.Mesh(new THREE.BoxGeometry(3,6,0.4),trimMat);
  securityDoor.position.set(10,3,5);
  securityDoor.userData.locked=true;
  scene.add(securityDoor);
  addCollisionFrom(securityDoor);

  grabpack=new THREE.Mesh(new THREE.BoxGeometry(1.5,2,0.5),new THREE.MeshStandardMaterial({color:0x00b0ff}));
  grabpack.position.set(15,1.2,5);
  grabpack.userData.type="grabpack";
  secRoom.add(grabpack);

  // Power Room left
  const powerRoom=makeRoom(12,12,6);
  powerRoom.position.set(-15,0,-5);
  scene.add(powerRoom);

  const powerDoor=new THREE.Mesh(new THREE.BoxGeometry(3,6,0.4),trimMat);
  powerDoor.position.set(-10,3,-5);
  scene.add(powerDoor);
  addCollisionFrom(powerDoor);

  powerPad=new THREE.Mesh(new THREE.CylinderGeometry(0.8,0.8,0.3,16),new THREE.MeshStandardMaterial({color:0xffaa00}));
  powerPad.position.set(-15,0.2,-5);
  powerPad.userData.type="powerPad";
  powerRoom.add(powerPad);

  // Factory door (to fuses) front wall
  factoryDoor=new THREE.Mesh(new THREE.BoxGeometry(4,6,0.4),trimMat);
  factoryDoor.position.set(0,3,-15);
  factoryDoor.userData.locked=true;
  scene.add(factoryDoor);
  addCollisionFrom(factoryDoor);

  // Fuse room corridor & room
  const fuseCorr=new THREE.Mesh(new THREE.BoxGeometry(6,4,20),wallMat);
  fuseCorr.position.set(0,2,-30);
  scene.add(fuseCorr);
  addCollisionFrom(fuseCorr);

  const fuseRoom=makeRoom(14,14,6);
  fuseRoom.position.set(0,0,-45);
  scene.add(fuseRoom);

  fusePanel=new THREE.Mesh(new THREE.BoxGeometry(2,3,0.3),new THREE.MeshStandardMaterial({color:0x555555}));
  fusePanel.position.set(0,2,-7);
  fusePanel.userData.type="fusePanel";
  fuseRoom.add(fusePanel);

  fuseMeshes=[];
  for(let i=0;i<4;i++){
    const f=new THREE.Mesh(new THREE.BoxGeometry(0.5,1,0.5),new THREE.MeshStandardMaterial({color:0xffff00}));
    f.position.set((i-1.5)*2,1, (i%2===0? -3:3));
    f.userData.type="fuse";
    fuseRoom.add(f);
    fuseMeshes.push(f);
  }

  // Corridor to Make-A-Friend
  const mfCorr=new THREE.Mesh(new THREE.BoxGeometry(6,4,20),wallMat);
  mfCorr.position.set(0,2,-65);
  scene.add(mfCorr);
  addCollisionFrom(mfCorr);

  const makeFriend=makeRoom(24,24,8);
  makeFriend.position.set(0,0,-85);
  scene.add(makeFriend);

  toyNodes=[];
  for(let i=0;i<3;i++){
    const n=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshStandardMaterial({color:0xffaa00}));
    n.position.set((i-1)*6,3,-8);
    n.userData.type="toyNode";
    makeFriend.add(n);
    toyNodes.push(n);
  }

  toyGate=new THREE.Mesh(new THREE.BoxGeometry(4,6,0.4),trimMat);
  toyGate.position.set(0,3,10);
  toyGate.userData.locked=true;
  makeFriend.add(toyGate);
  addCollisionFrom(toyGate);

  const belt=new THREE.Mesh(new THREE.BoxGeometry(10,0.3,2),new THREE.MeshStandardMaterial({color:0x333333}));
  belt.position.set(0,0.3,0);
  makeFriend.add(belt);

  catBee=new THREE.Mesh(new THREE.BoxGeometry(1,1,1.5),new THREE.MeshStandardMaterial({color:0xffdd44}));
  catBee.position.set(0,0.9,0);
  catBee.visible=false;
  catBee.userData.type="toy";
  makeFriend.add(catBee);

  // Vent corridor for chase
  const vent=makeRoom(6,40,4);
  vent.position.set(0,0,-115);
  scene.add(vent);

  huggyChase=new THREE.Mesh(new THREE.BoxGeometry(2,5,2),hudMat);
  huggyChase.position.set(0,2,-95);
  vent.add(huggyChase);

  // Catwalks & crate
  const catwalkFloor=new THREE.Mesh(new THREE.BoxGeometry(3,0.2,30),new THREE.MeshStandardMaterial({color:0x444444}));
  catwalkFloor.position.set(0,5,-140);
  scene.add(catwalkFloor);
  addCollisionFrom(catwalkFloor);

  crate=new THREE.Mesh(new THREE.BoxGeometry(3,2,3),new THREE.MeshStandardMaterial({color:0x666666}));
  crate.position.set(0,10,-145);
  scene.add(crate);

  // Poppy door & room
  poppyDoor=new THREE.Mesh(new THREE.BoxGeometry(4,6,0.4),trimMat);
  poppyDoor.position.set(0,3,-155);
  scene.add(poppyDoor);
  addCollisionFrom(poppyDoor);

  const poppyRoom=makeRoom(12,12,6);
  poppyRoom.position.set(0,0,-175);
  scene.add(poppyRoom);

  poppyCase=new THREE.Mesh(new THREE.BoxGeometry(2,4,2),new THREE.MeshStandardMaterial({color:0x9999ff,transparent:true,opacity:0.3}));
  poppyCase.position.set(0,2,-4);
  poppyCase.userData.type="poppyCase";
  poppyRoom.add(poppyCase);
}

function canMoveTo(nextPos,radius=0.7){
  for(const box of collisionBoxes){
    const expanded=box.clone();
    expanded.min.x-=radius;
    expanded.max.x+=radius;
    expanded.min.z-=radius;
    expanded.max.z+=radius;
    expanded.min.y=-Infinity;
    expanded.max.y=Infinity;
    if(expanded.containsPoint(nextPos)){
      return false;
    }
  }
  return true;
}

// ===== INTERACTION =====
function tryInteract(){
  if(state==="dead"||state==="credits")return;
  const pos=player.position.clone();

  if(state==="lobby"){
    if(greenTape && greenTape.position.distanceTo(pos)<2){
      hud.textContent="LOBBY\nLeith Pierre warns: \"Please obey Playtime Co. policies.\"";
      inventory.haveTape=true;
      greenTape.visible=false;
      securityDoor.userData.locked=false;
      info.textContent="Hands: 0 | Fuses: 0 | Toy: no\nSecurity Office unlocked.";
    }
    if(!securityDoor.userData.locked && pos.distanceTo(securityDoor.position)<3){
      hud.textContent="SECURITY OFFICE\nGrabPack is on the desk.";
      state="security";
    }
  }else if(state==="security"){
    if(grabpack && grabpack.position.clone().add(new THREE.Vector3(15,0,5).sub(new THREE.Vector3(15,0,5))).distanceTo(pos)<3){
      inventory.grabHands=1;
      grabpack.visible=false;
      hud.textContent="LOBBY\nYou have the blue GrabPack hand.\nLeft hall: power room.";
      state="lobby";
      info.textContent="Hands: 1 | Fuses: 0 | Toy: no";
    }
  }else if(state==="power"){
    if(powerPad && powerPad.position.clone().add(new THREE.Vector3(-15,0,-5).sub(new THREE.Vector3(-15,0,-5))).distanceTo(pos)<3){
      hud.textContent="POWER ROOM\nPower restored.\nReturn to lobby.";
      factoryDoor.userData.locked=false;
      state="lobby";
    }
  }else if(state==="fuses"){
    fuseMeshes.forEach(f=>{
      if(f.visible && f.position.clone().add(new THREE.Vector3(0,0,-45)).distanceTo(pos)<2){
        f.visible=false;
        inventory.fuses++;
        hud.textContent=`FUSE ROOM\nFuses collected: ${inventory.fuses}/4`;
        info.textContent=`Hands: 1 | Fuses: ${inventory.fuses} | Toy: no`;
      }
    });
    if(inventory.fuses>=4 && fusePanel.position.clone().add(new THREE.Vector3(0,0,-45)).distanceTo(pos)<3){
      inventory.grabHands=2;
      hud.textContent="FUSE ROOM\nPower restored. You now have both GrabPack hands.\nHead deeper into the factory.";
      info.textContent=`Hands: 2 | Fuses: 4 | Toy: no`;
      state="factoryHalls";
    }
  }else if(state==="makeFriend"){
    toyNodes.forEach(n=>{
      if(n.userData.active!==true && n.position.clone().add(new THREE.Vector3(0,0,-85)).distanceTo(pos)<3){
        n.material.color.set(0x00ff00);
        n.userData.active=true;
      }
    });
    if(toyNodes.every(n=>n.userData.active===true) && !inventory.toyCrafted){
      inventory.toyCrafted=true;
      catBee.visible=true;
      hud.textContent="MAKE-A-FRIEND\nToy is ready. Pick it up.";
      info.textContent=`Hands: 2 | Fuses: 4 | Toy: yes`;
    }
    if(inventory.toyCrafted && catBee.visible && catBee.position.clone().add(new THREE.Vector3(0,0,-85)).distanceTo(pos)<3){
      catBee.visible=false;
      toyGate.userData.locked=false;
      hud.textContent="MAKE-A-FRIEND\nGate open. Head into the dark hallway.";
    }
  }else if(state==="poppy"){
    if(poppyCase && poppyCase.position.clone().add(new THREE.Vector3(0,0,-175)).distanceTo(pos)<3){
      state="credits";
      stopAllMusic();
      fadeIn(protoMusic,options.masterVolume,1500);
      creditsUI.style.display="flex";
      hud.textContent="";
      info.textContent="";
    }
  }
}

// ===== MAIN LOOP =====
function animate(){
  requestAnimationFrame(animate);
  if(!renderer||!scene)return;
  const dt=0.016;

  if(state!=="dead" && state!=="credits"){
    const forward=new THREE.Vector3();
    camera.getWorldDirection(forward);
    forward.y=0;forward.normalize();
    const right=new THREE.Vector3();
    right.crossVectors(forward,new THREE.Vector3(0,1,0)).normalize();

    let move=new THREE.Vector3();
    if(keys["KeyW"])move.add(forward);
    if(keys["KeyS"])move.sub(forward);
    if(keys["KeyA"])move.sub(right);
    if(keys["KeyD"])move.add(right);
    if(move.lengthSq()>0)move.normalize();

    const speed=6;
    const step=move.clone().multiplyScalar(speed*dt);
    const nextPos=player.position.clone().add(step);
    if(canMoveTo(nextPos,0.7)){
      player.position.copy(nextPos);
    }
    player.position.y=2; // floor lock

    // rough state changes based on position
    const z=player.position.z;
    if(state==="lobby"){
      if(z<-10 && !factoryDoor.userData.locked){
        state="fuses";
        hud.textContent="FUSE ROOM\nCollect all four fuses.";
      }else if(z<-10 && factoryDoor.userData.locked){
        state="power";
        hud.textContent="POWER ROOM\nUse the power pad.";
      }
    }else if(state==="fuses" && z<-60){
      state="makeFriend";
      hud.textContent="MAKE-A-FRIEND\nActivate all power nodes.";
    }else if(state==="makeFriend" && z<-105){
      if(!toyGate.userData.locked){
        state="chase";
        stopAllMusic();
        fadeIn(chaseMusic,options.masterVolume,1500);
        hud.textContent="VENT CHASE\nRun. If Huggy catches you, you die.";
      }
    }else if(state==="chase" && z<-135){
      state="catwalks";
      hud.textContent="CATWALKS\nDrop the crate on Huggy.";
    }else if(state==="catwalks" && z<-150){
      poppyDoor.position.y-=5*dt;
      if(poppyDoor.position.y<0){
        state="poppy";
        hud.textContent="POPPY ROOM\nOpen the case.";
        stopAllMusic();
        fadeIn(protoMusic,options.masterVolume,1500);
      }
    }

    // simple chase behaviour
    if(state==="chase" && huggyChase){
      const target=player.position.clone();
      const pos=huggyChase.position;
      const dir=target.sub(pos);dir.y=0;
      const d=dir.length();
      if(d>0.01)dir.normalize();
      huggyChase.position.addScaledVector(dir,8*dt);
      if(d<2.5){
        triggerJumpscareAndDeath();
      }
    }

    // crate kill stub: if player steps near crate, we "drop" it
    if(state==="catwalks" && crate){
      if(player.position.distanceTo(crate.position)<5){
        crate.position.y-=20*dt;
        if(crate.position.y<3){
          crate.position.y=3;
        }
      }
    }
  }

  renderer.render(scene,camera);
}
</script>
</body>
</html>
