<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Project Playcare</title>
<style>
body{
  margin:0;
  overflow:hidden;
  background:black;
  font-family:Arial, system-ui, sans-serif;
}
#title,#ending{
  position:absolute;
  width:100%;
  height:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  background:black;
  color:white;
  z-index:20;
}
#title h1{
  font-size:52px;
  margin:0 0 10px 0;
  letter-spacing:4px;
}
#title p{
  max-width:460px;
  text-align:center;
  font-size:14px;
  opacity:.85;
  margin:4px 0;
  white-space:pre-line;
}
button{
  padding:12px 25px;
  margin-top:18px;
  font-size:18px;
  cursor:pointer;
  background:#ff2222;
  border:none;
  border-radius:4px;
  color:white;
}
button:hover{
  background:#ff4444;
}
#ending h1{
  font-size:40px;
  letter-spacing:5px;
}
#ending p{
  font-size:14px;
  opacity:.9;
}

#healthBox{
  position:absolute;
  top:20px;
  left:20px;
  width:220px;
  height:22px;
  border:2px solid white;
  display:none;
  z-index:5;
}
#healthBar{height:100%;width:100%;background:red}
#crosshair{
  position:absolute;
  top:50%;left:50%;
  width:6px;height:6px;
  background:white;
  transform:translate(-50%,-50%);
  display:none;
  z-index:5;
}
#flash{
  position:absolute;
  width:100%;height:100%;
  background:red;
  opacity:0;
  pointer-events:none;
  transition:opacity .1s;
  z-index:10;
}
#hudText{
  position:absolute;
  bottom:20px;
  left:20px;
  color:white;
  font-size:14px;
  text-shadow:0 0 4px #000;
  z-index:5;
  white-space:pre-line;
}
#infoText{
  position:absolute;
  top:20px;
  right:20px;
  color:white;
  font-size:13px;
  text-align:right;
  opacity:.8;
  text-shadow:0 0 4px #000;
  z-index:5;
}

/* Jumpscare overlay */
#jumpscare{
  position:absolute;
  inset:0;
  background:black;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:25;
}
#jumpscare img{
  max-width:100%;
  max-height:100%;
  object-fit:contain;
}
</style>
</head>
<body>

<div id="title">
  <h1>PROJECT PLAYCARE</h1>
  <p>
A Poppy Playtime: Chapter 3–inspired fan scene.

You wake up in a hallway deep in Playcare.
CatNap will not let you leave.

Controls:
WASD – move
SPACE – jump
E – interact (generator)
Mouse – look
  </p>
  <button id="start">START</button>
</div>

<div id="ending" style="display:none;">
  <h1>SEE YOU SOON</h1>
  <p>Thanks for playing this Project Playcare prototype.</p>
</div>

<div id="healthBox"><div id="healthBar"></div></div>
<div id="crosshair"></div>
<div id="flash"></div>
<div id="hudText"></div>
<div id="infoText"></div>

<!-- Jumpscare overlay (use your own image if you like) -->
<div id="jumpscare">
  <!-- Optional placeholder image. Replace src or remove <img> if you only want flash + sound. -->
  <!-- <img src="catnap_jumpscare.png" alt="CatNap"> -->
</div>

<audio id="titleMusic" src="Title music.mp3" loop></audio>
<audio id="hallMusic" src="Bgm-1.mp3" loop></audio>
<audio id="bossMusic" src="chase music.mp3" loop></audio>
<audio id="protoMusic" src="Prototype encounter music.mp3" loop></audio>
<!-- Optional jumpscare sound -->
<audio id="jumpscareSound" src="jumpscare.mp3"></audio>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>

// ===== GLOBALS & STATE =====
let scene,camera,renderer,player,catnap,generator,arenaDoor,protoDoor
let state="title"
let health=100
let batteries=0
let keys={}
let yaw=0,pitch=0
let velocityY=0
let bossDoorOpen=false
let protoTimer=0
let catnapDead=false
let generatorPowered=false
let protoDoorOpen=false
let catnapDeathTimer=0

// UI refs
const titleUI=document.getElementById("title")
const endingUI=document.getElementById("ending")
const healthBar=document.getElementById("healthBar")
const healthBox=document.getElementById("healthBox")
const crosshair=document.getElementById("crosshair")
const flash=document.getElementById("flash")
const hudText=document.getElementById("hudText")
const infoText=document.getElementById("infoText")
const jumpscare=document.getElementById("jumpscare")

// Audio refs
const titleMusic=document.getElementById("titleMusic")
const hallMusic=document.getElementById("hallMusic")
const bossMusic=document.getElementById("bossMusic")
const protoMusic=document.getElementById("protoMusic")
const jumpscareSound=document.getElementById("jumpscareSound")

function fadeIn(a,v=1,d=2000){
  a.volume=0
  a.play().catch(()=>{})
  let step=v/(d/50)
  let i=setInterval(()=>{
    a.volume=Math.min(v,a.volume+step)
    if(a.volume>=v)clearInterval(i)
  },50)
}
function fadeOut(a,d=2000){
  let step=a.volume/(d/50 || 1)
  let i=setInterval(()=>{
    a.volume=Math.max(0,a.volume-step)
    if(a.volume<=0){
      a.pause()
      clearInterval(i)
    }
  },50)
}

// Title music
fadeIn(titleMusic,.7)

document.getElementById("start").onclick=()=>{
  fadeOut(titleMusic)
  titleUI.style.display="none"
  init()
}

// ===== JUMPSCARE LOGIC =====
let jumpscareCooldown = 0; // small cooldown so it isn't constant spam

function triggerJumpscare(){
  const now = performance.now();
  if (now - jumpscareCooldown < 400) return; // cooldown ~0.4s

  jumpscareCooldown = now;

  // show overlay briefly
  jumpscare.style.display="flex";
  flash.style.opacity=1;
  if(jumpscareSound){
    jumpscareSound.currentTime=0;
    jumpscareSound.play().catch(()=>{});
  }
  setTimeout(()=>{
    jumpscare.style.display="none";
    flash.style.opacity=0;
  }, 220); // quick scare
}

// ===== INIT SCENE =====
function init(){
  scene=new THREE.Scene()
  scene.fog=new THREE.Fog(0x220000,10,220)

  camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,2000)
  renderer=new THREE.WebGLRenderer({antialias:true})
  renderer.setSize(innerWidth,innerHeight)
  document.body.appendChild(renderer.domElement)

  renderer.domElement.requestPointerLock=
    renderer.domElement.requestPointerLock||
    renderer.domElement.mozRequestPointerLock

  renderer.domElement.addEventListener("click",
    ()=>renderer.domElement.requestPointerLock())

  // Lighting: red/Playcare vibe
  scene.add(new THREE.AmbientLight(0xff0000,.3))
  let light=new THREE.PointLight(0xff4444,2,80)
  light.position.set(0,8,0)
  scene.add(light)

  const wallMat=new THREE.MeshStandardMaterial({color:0x333333})
  const floorMat=new THREE.MeshStandardMaterial({color:0x222222})

  function wall(x,y,z,w,h,d){
    let m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),wallMat)
    m.position.set(x,y,z)
    scene.add(m)
    return m
  }
  function floor(x,z,w,d){
    let m=new THREE.Mesh(new THREE.BoxGeometry(w,1,d),floorMat)
    m.position.set(x,-0.5,z)
    scene.add(m)
    return m
  }

  // ===== HALLWAY =====
  floor(0,-70,20,240)
  wall(-10,5,-70,1,10,240)
  wall(10,5,-70,1,10,240)
  wall(0,10,-70,20,1,240)

  // ===== BOSS DOOR (to arena) =====
  arenaDoor=new THREE.Mesh(new THREE.BoxGeometry(8,8,1),wallMat)
  arenaDoor.position.set(0,4,-160)
  scene.add(arenaDoor)

  // ===== ARENA (bigger, square) =====
  floor(0,-230,80,80)
  wall(-40,5,-230,1,10,80)
  wall(40,5,-230,1,10,80)
  wall(0,10,-230,80,1,80)
  wall(0,5,-270,80,10,1)

  // ===== GENERATOR (center) =====
  generator=new THREE.Mesh(
    new THREE.CylinderGeometry(4,4,8,16),
    new THREE.MeshStandardMaterial({color:0x00b0ff})
  )
  generator.position.set(0,4,-230)
  generator.userData.generator=true
  scene.add(generator)

  // ===== BATTERIES (4) =====
  for(let i=0;i<4;i++){
    let b=new THREE.Mesh(
      new THREE.BoxGeometry(2,2,2),
      new THREE.MeshStandardMaterial({color:0xffff00})
    )
    b.position.set(
      (Math.random()-0.5)*60,
      1,
      -230 + (Math.random()-0.5)*60
    )
    b.userData.battery=true
    scene.add(b)
  }

  // ===== PROTOTYPE ROOM DOOR (locked until CatNap dies) =====
  protoDoor=new THREE.Mesh(new THREE.BoxGeometry(8,8,1),wallMat)
  protoDoor.position.set(0,4,-280)
  scene.add(protoDoor)

  // Prototype room floor & walls
  floor(0,-295,40,40)
  wall(-20,5,-295,1,10,40)
  wall(20,5,-295,1,10,40)
  wall(0,10,-315,40,1,40)

  // ===== PROTOTYPE HAND & EYE =====
  let hand=new THREE.Mesh(
    new THREE.BoxGeometry(6,2,10),
    new THREE.MeshStandardMaterial({color:0x555555})
  )
  hand.position.set(0,2,-300)
  scene.add(hand)

  let eye=new THREE.Mesh(
    new THREE.SphereGeometry(2,16,16),
    new THREE.MeshBasicMaterial({color:0xffff00})
  )
  eye.position.set(0,5,-310)
  scene.add(eye)

  // ===== PLAYER =====
  player=new THREE.Object3D()
  player.position.set(0,2,30)
  scene.add(player)
  player.add(camera)

  healthBox.style.display="block"
  crosshair.style.display="block"
  state="hall"
  bossDoorOpen=false
  catnapDead=false
  generatorPowered=false
  protoDoorOpen=false
  protoTimer=0
  catnapDeathTimer=0
  batteries=0
  health=100
  healthBar.style.width=health+"%"
  hudText.textContent="Reach the end of the hallway.\nCatNap is behind you."
  infoText.textContent="Batteries: 0 / 4"

  fadeIn(hallMusic,.6)

  // ===== CATNAP =====
  let body=new THREE.Mesh(
    new THREE.BoxGeometry(4,8,4),
    new THREE.MeshStandardMaterial({color:0x2a0033})
  )
  let head=new THREE.Mesh(
    new THREE.BoxGeometry(4,4,4),
    new THREE.MeshStandardMaterial({color:0x2a0033})
  )
  head.position.y=6
  body.add(head)
  let eyeL=new THREE.Mesh(
    new THREE.SphereGeometry(.5,8,8),
    new THREE.MeshBasicMaterial({color:0xffffff})
  )
  let eyeR=eyeL.clone()
  eyeL.position.set(-1,6.5,2.2)
  eyeR.position.set(1,6.5,2.2)
  body.add(eyeL);body.add(eyeR)
  catnap=body
  catnap.position.set(0,4,80)
  scene.add(catnap)

  animate()
}

/* ===== CONTROLS ===== */
document.addEventListener("mousemove",e=>{
  if(document.pointerLockElement===renderer?.domElement){
    yaw-=e.movementX*.002
    pitch-=e.movementY*.002
    pitch=Math.max(-Math.PI/2,Math.min(Math.PI/2,pitch))
    if(player){
      player.rotation.y=yaw
      camera.rotation.x=pitch
    }
  }
})
document.addEventListener("keydown",e=>keys[e.code]=true)
document.addEventListener("keyup",e=>keys[e.code]=false)

/* ===== MAIN LOOP ===== */
function animate(){
  requestAnimationFrame(animate)
  if(!scene)return
  const delta=.016

  // Movement
  if(state!=="ending"){
    let forward=new THREE.Vector3()
    camera.getWorldDirection(forward)
    forward.y=0;forward.normalize()
    let right=new THREE.Vector3()
    right.crossVectors(forward,new THREE.Vector3(0,1,0)).normalize()
    let move=new THREE.Vector3()
    if(keys["KeyW"])move.add(forward)
    if(keys["KeyS"])move.sub(forward)
    if(keys["KeyA"])move.sub(right)
    if(keys["KeyD"])move.add(right)
    if(move.lengthSq()>0)move.normalize()
    player.position.addScaledVector(move,9*delta)

    // Constrain hall/arena roughly by walls
    if(player.position.x<-9.5)player.position.x=-9.5
    if(player.position.x>9.5)player.position.x=9.5

    // Jump & gravity
    velocityY-=30*delta
    if(keys["Space"]&&player.position.y<=2.01)velocityY=12
    player.position.y+=velocityY*delta
    if(player.position.y<2){player.position.y=2;velocityY=0}
  }

  // CatNap chase & damage
  if(state!=="ending" && !catnapDead){
    let dir=new THREE.Vector3().subVectors(player.position,catnap.position)
    dir.y=0
    let dist=dir.length()
    if(dist>0.01)dir.normalize()
    let speed=(state==="hall")?5:7
    catnap.position.addScaledVector(dir,speed*delta)
    catnap.lookAt(player.position)

    if(dist<3){
      // Damage + jumpscare every time he hits you
      const previousHealth = health
      health-=0.9
      if(health<0)health=0
      if(health<previousHealth){
        triggerJumpscare()
      }
      healthBar.style.width=health+"%"
    }
  }

  // Hall → Boss door opening
  if(state==="hall" && player.position.z<-150 && !bossDoorOpen){
    arenaDoor.position.y+=10*delta
    if(arenaDoor.position.y>20){
      bossDoorOpen=true
      fadeOut(hallMusic,1500)
      fadeIn(bossMusic,.8,1500)
      state="boss"
      hudText.textContent="Boss arena.\nCollect all batteries, then interact (E) with the generator."
    }
  }

  // Boss logic
  if(state==="boss"){
    if(player.position.x<-39)player.position.x=-39
    if(player.position.x>39)player.position.x=39
    if(player.position.z<-270)player.position.z=-270
    if(player.position.z>-190)player.position.z=-190

    // Collect batteries
    scene.traverse(o=>{
      if(o.userData && o.userData.battery){
        let d=o.position.distanceTo(player.position)
        if(d<3){
          o.userData.battery=false
          scene.remove(o)
          batteries++
          infoText.textContent=`Batteries: ${batteries} / 4`
        }
      }
    })

    // Power generator once when you have all batteries
    if(batteries>=4 &&
       player.position.distanceTo(generator.position)<7 &&
       keys["KeyE"] &&
       !generatorPowered){
      generatorPowered=true
      generator.material.color.set(0x00ff00)
      hudText.textContent="Generator powered.\nThe red cat goes quiet…"
      catnapDeathTimer=0
    }

    // CatNap death after generator power
    if(generatorPowered && !catnapDead){
      catnapDeathTimer+=delta
      if(catnapDeathTimer>1.2){
        catnapDead=true
        catnap.visible=false
        fadeOut(bossMusic,1500)
        hudText.textContent="It’s finally quiet.\nSomething opens deeper in Playcare…"
      }
    }

    // Open Prototype door
    if(catnapDead && !protoDoorOpen){
      protoDoor.position.y+=15*delta
      if(protoDoor.position.y>20){
        protoDoorOpen=true
      }
    }

    // Enter Prototype room
    if(protoDoorOpen && player.position.z<-275){
      state="proto"
      fadeIn(protoMusic,.7,1500)
      hudText.textContent="A mechanical hand waits ahead.\nYou are being watched."
    }
  }

  // Prototype / ending
  if(state==="proto"){
    protoTimer+=delta
    if(protoTimer>9){
      endingUI.style.display="flex"
      state="ending"
      hudText.textContent=""
      infoText.textContent=""
    }
  }

  // Death reset
  if(health<=0 && state!=="ending"){
    location.reload()
  }

  renderer.render(scene,camera)
}

window.addEventListener("resize",()=>{
  if(!camera || !renderer)return
  camera.aspect=innerWidth/innerHeight
  camera.updateProjectionMatrix()
  renderer.setSize(innerWidth,innerHeight)
})

</script>
</body>
</html>
